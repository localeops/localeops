name: Release

# Trigger this workflow only after CI workflow completes successfully
on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main

# workflow_run has write-all by default, so we explicitly restrict to least privilege at job level
# Reference: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#permissions
permissions: {}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    # Only run if the CI workflow completed successfully
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    # Permissions required for semantic-release to work properly
    permissions:
      # Required permissions
      issues: write        # Required to comment on related issues in release notes
      contents: write      # Required to push commits (version bumps) and create tags
      id-token: write      # Required for NPM provenance and OIDC authentication
      pull-requests: write # Required to comment on related PRs in release notes

      # Explicitly denied permissions
      actions: none             # Work with GitHub Actions (cancel workflow runs)
      attestations: none        # Generate artifact attestations for build provenance
      checks: none              # Work with check runs and check suites
      deployments: none         # Work with deployments
      discussions: none         # Interact with GitHub Discussions
      packages: none            # Upload and publish packages on GitHub Packages
      pages: none               # Request GitHub Pages builds
      repository-projects: none # Work with repository projects
      security-events: none     # Access code scanning alerts
      statuses: none            # List and manage commit statuses
    steps:
      # Generate a LocaleOps Bot token
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.LOCALEOPS_BOT_APP_ID }}
          private-key: ${{ secrets.LOCALEOPS_BOT_PRIVATE_KEY }}

      # Checkout the repository code
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          # fetch-depth: 0 fetches all history for all branches and tags
          # This is required for semantic-release to analyze all commits
          fetch-depth: 0
          # Use PAT token to bypass branch protection rules
          token: ${{ steps.app-token.outputs.token }}

      # Setup Node.js LTS
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 'lts/*'

      # Install Bun runtime
      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2.1.2
        with:
          bun-version: latest

      # Install project dependencies
      - name: Install dependencies
        run: bun install --ignore-scripts

      # Run semantic-release to analyze commits and create releases
      - name: Release
        env:
          # Use PAT token to bypass branch protection and push version commits
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          # NPM token for publishing to npm registry
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: bunx semantic-release
