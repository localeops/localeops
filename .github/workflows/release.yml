name: Release

# Trigger this workflow only after CI workflow completes successfully
on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main

# Permissions required for semantic-release to work properly
permissions:
  issues: write         # Required to comment on related issues in release notes
  contents: write       # Required to push commits (version bumps) and create tags
  pull-requests: write  # Required to comment on related PRs in release notes
  id-token: write       # Required for NPM provenance and OIDC authentication

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    # Only run if the CI workflow completed successfully
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      # Checkout the repository code
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 fetches all history for all branches and tags
          # This is required for semantic-release to analyze all commits
          fetch-depth: 0
          # Use PAT token to bypass branch protection rules
          token: ${{ secrets.PAT_TOKEN }}

      # Setup Node.js LTS
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      # Install Bun runtime
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # Install project dependencies
      - name: Install dependencies
        run: bun install --frozen-lockfile

      # Run semantic-release to analyze commits and create releases
      - name: Release
        env:
          # Use PAT token to bypass branch protection and push version commits
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          # NPM token for publishing to npm registry
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: bunx semantic-release
