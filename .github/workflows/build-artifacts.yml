name: Build Artifacts

# Trigger when a release is published by semantic-release
on:
  release:
    types: [published]

# Set minimal permissions at top level, grant specific permissions at job level
# Reference: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#permissions
permissions: {}

jobs:
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    # Required permissions to upload release assets and create attestations
    permissions:
      # Required permissions
      attestations: write  # Required for GitHub attestations
      contents: write      # Required to upload release assets
      id-token: write      # Required for build provenance attestation

      # Explicitly denied permissions
      actions: none             # Work with GitHub Actions (cancel workflow runs)
      checks: none              # Work with check runs and check suites
      deployments: none         # Work with deployments
      discussions: none         # Interact with GitHub Discussions
      issues: none              # Work with issues
      packages: none            # Upload and publish packages on GitHub Packages
      pages: none               # Request GitHub Pages builds
      pull-requests: none       # Work with pull requests
      repository-projects: none # Work with repository projects
      security-events: none     # Access code scanning alerts
      statuses: none            # List and manage commit statuses
    strategy:
      matrix:
        # Build matrix for cross-platform binaries
        # To add a new platform:
        # 1. Add a new entry with os, platform, and target
        # 2. platform: used for naming the output file (e.g., localeops-linux-x64)
        # 3. target: Bun's build target (e.g., bun-linux-x64)
        include:
          # Linux x86-64 - Standard Linux, AWS Lambda x86, most VPS/containers
          - os: ubuntu-latest
            platform: linux-x64
            target: bun-linux-x64
          # Linux ARM64 - AWS Lambda Graviton2 (cheaper), ARM servers
          - os: ubuntu-latest
            platform: linux-arm64
            target: bun-linux-arm64
          # macOS ARM64 - Apple Silicon Macs (M1, M2, M3, etc.)
          - os: macos-latest
            platform: darwin-arm64
            target: bun-darwin-arm64

    steps:
      # Checkout the repository code
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      # Setup Node.js LTS (required for some dependencies)
      - name: Setup Node.js LTS
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 'lts/*'

      # Setup Bun runtime for building
      - name: Setup Bun
        uses: oven-sh/setup-bun@b7a1c7ccf290d58743029c4f6903da283811b979 # v2.1.0
        with:
          bun-version: latest

      # Cache Bun dependencies for faster builds
      - name: Cache Bun dependencies
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      # Install project dependencies
      - name: Install dependencies
        run: bun install --ignore-scripts

      # Build the standalone binary for the target platform
      # --compile: Creates a standalone executable
      # --minify: Reduces binary size
      # --sourcemap: Generates source maps for debugging
      # --target: Specifies the platform to build for
      - name: Build binary for ${{ matrix.platform }}
        run: |
          bun build src/index.ts --compile --minify --sourcemap --target=${{ matrix.target }} --outfile=dist/localeops-${{ matrix.platform }}

      # Verify the binary was created successfully
      - name: Verify binary exists
        shell: bash
        run: |
          ls -la dist/localeops-${{ matrix.platform }}
          file dist/localeops-${{ matrix.platform }} || echo "file command not available"

      # Generate SHA256 checksums for security verification
      - name: Generate checksums
        shell: bash
        run: |
          cd dist
          if command -v sha256sum > /dev/null; then
            sha256sum localeops-${{ matrix.platform }} > localeops-${{ matrix.platform }}.sha256
          else
            shasum -a 256 localeops-${{ matrix.platform }} > localeops-${{ matrix.platform }}.sha256
          fi
          echo "Checksum generated:"
          cat *.sha256

      # Attest the binary with GitHub's build provenance
      - name: Attest binary provenance
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3.1.0
        with:
          subject-path: 'dist/localeops-${{ matrix.platform }}'

      # Sign the binary with Sigstore for cryptographic verification
      - name: Sign binary with Sigstore
        uses: sigstore/gh-action-sigstore-python@a5caf349bc536fbef3668a10ed7f5cd309a4b53d # v3.2.0
        with:
          inputs: dist/localeops-${{ matrix.platform }}

      # Generate a LocaleOps Bot token
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.LOCALEOPS_BOT_APP_ID }}
          private-key: ${{ secrets.LOCALEOPS_BOT_PRIVATE_KEY }}

      # Upload the binary, checksum, and signature files to the GitHub release
      - name: Upload artifacts to release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: |
            dist/localeops-${{ matrix.platform }}
            dist/localeops-${{ matrix.platform }}.sha256
            dist/localeops-${{ matrix.platform }}.sigstore
            dist/localeops-${{ matrix.platform }}.sigstore.json
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      # Upload as workflow artifacts for debugging
      - name: Upload workflow artifacts
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: debug-${{ matrix.platform }}
          path: dist/
          retention-days: 7
