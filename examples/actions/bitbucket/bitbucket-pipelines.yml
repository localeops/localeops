image: node:20 # Use Node.js 20 Docker image for the pipeline steps

pipelines:
  custom:
    # Custom pipeline to extract untranslated strings from your project
    localeops-extract:
      - variables:
          - name: LOCALE        # Locale to extract strings for (e.g., en, fr)
          - name: CALLBACK_URL  # Endpoint where extraction results will be sent
      
      - step:
          name: Extract untranslated strings
          oidc: true            # Enable OIDC for secure auth if needed by your environment
          caches:
            - node              # Cache node_modules to speed up subsequent runs
          script:
            - export TOKEN="${BITBUCKET_TOKEN}"      # Expose Bitbucket token as TOKEN for LocaleOps
            - npx @localeops/localeops extract "${LOCALE}" "${CALLBACK_URL}" # Run extraction for the given locale and callback

    # Custom pipeline to apply downloaded translations back into the repo
    localeops-apply:
      - variables:
          - name: LOCALE        # Locale to apply translations for
          - name: TRANSLATIONS  # Serialized translations payload (e.g., JSON)
      - step:
          name: Apply translations
          oidc: true            # Enable OIDC for secure auth if needed by your environment
          caches:
            - node              # Cache node_modules to speed up subsequent runs
          script:
            - git config user.name "Bitbucket Pipelines"          # Configure Git author name
            - git config user.email "pipelines@bitbucket.org"     # Configure Git author email
            - export TOKEN="${BITBUCKET_TOKEN}"                   # Expose Bitbucket token as TOKEN for LocaleOps
            - npx @localeops/localeops apply "${LOCALE}" "${TRANSLATIONS}"       # Apply translations and commit changes
